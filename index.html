<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment Process Dependency Flow</title>
  <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.3.2/cytoscape-dagre.js"></script>
  <style>
    body {
      margin: 0;
      background: #f9f9f9;
    }
    #cy {
      width: 100vw;
      height: 100vh;
      display: block;
      background: #ffffff;
    }
  </style>
</head>
<body>

<div id="cy"></div>

<script>
var cy = cytoscape({
  container: document.getElementById('cy'),
    // ==== Nodes ====
    { data: { id: 'ExternalTrigger', label: 'External Trigger - User or API' } },
    { data: { id: '1A', label: '1A: Channel access & log-in' } },
    { data: { id: '1B', label: '1B: Payment setup' } },
    { data: { id: '1C', label: '1C: Data entry & input validation' } },
    { data: { id: '1D', label: '1D: Submission & pre-capture' } },
    { data: { id: '2A', label: '2A: Credential verification' } },
    { data: { id: '2B', label: '2B: Multi-factor / risk checks' } },
    { data: { id: '2C', label: '2C: Corporate role / limit checks' } },
    { data: { id: '2D', label: '2D: Session creation' } },
    { data: { id: '3A', label: '3A: Data completeness' } },
    { data: { id: '3B', label: '3B: Business-rule enforcement' } },
    { data: { id: '3C', label: '3C: Preliminary AML / watch-list' } },
    { data: { id: '3D', label: '3D: Error feedback / repair' } },
    { data: { id: '4A', label: '4A: Payment classification' } },
    { data: { id: '4B', label: '4B: Network selection' } },
    { data: { id: '4C', label: '4C: Route optimisation' } },
    { data: { id: '4D', label: '4D: Handoff to next layer' } },
    { data: { id: '5A', label: '5A: Transaction risk scoring' } },
    { data: { id: '5B', label: '5B: Sanctions & watch-list screening' } },
    { data: { id: '5C', label: '5C: AML transaction monitoring' } },
    { data: { id: '5D', label: '5D: Case handling / auto-clear' } },
    { data: { id: '6A', label: '6A: Confirmation of details' } },
    { data: { id: '6B', label: '6B: Dual / multi-signature' } },
    { data: { id: '6C', label: '6C: Systemic re-check' } },
    { data: { id: '6D', label: '6D: Lock-in & hand-over' } },
    { data: { id: '7A', label: '7A: Formatting for network' } },
    { data: { id: '7B', label: '7B: Data enrichment & mapping' } },
    { data: { id: '7C', label: '7C: Truncation / unmapped fields' } },
    { data: { id: '7D', label: '7D: Error / repair queue' } },
    { data: { id: '8A', label: '8A: Transmission to network' } },
    { data: { id: '8B', label: '8B: Queue & processing' } },
    { data: { id: '8C', label: '8C: Intermediary handling' } },
    { data: { id: '8D', label: '8D: Clearing completion' } },
    { data: { id: '9A', label: '9A: Reserve debit / credit' } },
    { data: { id: '9B', label: '9B: Beneficiary account credit' } },
    { data: { id: '9C', label: '9C: Intraday liquidity management' } },
    { data: { id: '9D', label: '9D: Finality & irrevocability' } },
    { data: { id: '10A', label: '10A: Internal reconciliation' } },
    { data: { id: '10B', label: '10B: Statement updates' } },
    { data: { id: '10C', label: '10C: Exceptions & returns' } },
    { data: { id: '10D', label: '10D: Investigation & dispute' } },
    { data: { id: '11A', label: '11A: Transactional alerts' } },
    { data: { id: '11B', label: '11B: Statement generation' } },
    { data: { id: '11C', label: '11C: Analytical dashboards' } },
    { data: { id: '11D', label: '11D: Real-time status tracking' } },
    { data: { id: '12A', label: '12A: Audit-trail capture' } },
    { data: { id: '12B', label: '12B: Long-term archival' } },
    { data: { id: '12C', label: '12C: Regulatory filings' } },
    { data: { id: '12D', label: '12D: Audit & retrieval' } },
    { data: { id: 'EventBus', label: 'Event bus (Stages 1-10)' } },
    { data: { id: 'AggregatedData', label: 'Aggregated Data (Stages 1-10)' } },
    { data: { id: 'StatusEvents', label: 'Status Events (Stages 1-10)' } },
    { data: { id: 'Logs', label: 'Logs (Stages 1-11)' } },
    { data: { id: 'Data', label: 'Data (Stages 1-11)' } },
    // ==== Edges ====
    { data: { source: 'ExternalTrigger', target: '1A' } },
    { data: { source: '1A', target: '1B' } },
    { data: { source: '1B', target: '1C' } },
    { data: { source: '1C', target: '1D' } },
    { data: { source: '1A', target: '2A' } },
    { data: { source: '1D', target: '2A' } },
    { data: { source: '2A', target: '2B' } },
    { data: { source: '1B', target: '2C' } },
    { data: { source: '2A', target: '2C' } },
    { data: { source: '2A', target: '2D' } },
    { data: { source: '2B', target: '2D' } },
    { data: { source: '2C', target: '2D' } },
    { data: { source: '1D', target: '3A' } },
    { data: { source: '1D', target: '3B' } },
    { data: { source: '2C', target: '3B' } },
    { data: { source: '3A', target: '3B' } },
    { data: { source: '1D', target: '3C' } },
    { data: { source: '3A', target: '3C' } },
    { data: { source: '3A', target: '3D' } },
    { data: { source: '3B', target: '3D' } },
    { data: { source: '3C', target: '3D' } },
    { data: { source: '1D', target: '4A' } },
    { data: { source: '3D', target: '4A' } },
    { data: { source: '4A', target: '4B' } },
    { data: { source: '4B', target: '4C' } },
    { data: { source: '4C', target: '4D' } },
    { data: { source: '1D', target: '5A' } },
    { data: { source: '2D', target: '5A' } },
    { data: { source: '4D', target: '5A' } },
    { data: { source: '1D', target: '5B' } },
    { data: { source: '4D', target: '5B' } },
    { data: { source: '1D', target: '5C' } },
    { data: { source: '4D', target: '5C' } },
    { data: { source: '5A', target: '5C' } },
    { data: { source: '5A', target: '5D' } },
    { data: { source: '5B', target: '5D' } },
    { data: { source: '5C', target: '5D' } },
    { data: { source: '1D', target: '6A' } },
    { data: { source: '5D', target: '6A' } },
    { data: { source: '6A', target: '6B' } },
    { data: { source: '1D', target: '6C' } },
    { data: { source: '2C', target: '6C' } },
    { data: { source: '5D', target: '6C' } },
    { data: { source: '6A', target: '6D' } },
    { data: { source: '6B', target: '6D' } },
    { data: { source: '6C', target: '6D' } },
    { data: { source: '4B', target: '7A' } },
    { data: { source: '6D', target: '7A' } },
    { data: { source: '1D', target: '7B' } },
    { data: { source: '6D', target: '7B' } },
    { data: { source: '7A', target: '7C' } },
    { data: { source: '7B', target: '7C' } },
    { data: { source: '7A', target: '7D' } },
    { data: { source: '7B', target: '7D' } },
    { data: { source: '7C', target: '7D' } },
    { data: { source: '7A', target: '8A' } },
    { data: { source: '7B', target: '8A' } },
    { data: { source: '7C', target: '8A' } },
    { data: { source: '7D', target: '8A' } },
    { data: { source: '8A', target: '8B' } },
    { data: { source: '4B', target: '8C' } },
    { data: { source: '7B', target: '8C' } },
    { data: { source: '8A', target: '8C' } },
    { data: { source: '8A', target: '8D' } },
    { data: { source: '8B', target: '8D' } },
    { data: { source: '8C', target: '8D' } },
    { data: { source: '8D', target: '9A' } },
    { data: { source: '8D', target: '9B' } },
    { data: { source: '9A', target: '9B' } },
    { data: { source: '4D', target: '9C' } },
    { data: { source: '8D', target: '9C' } },
    { data: { source: '9A', target: '9C' } },
    { data: { source: '9A', target: '9D' } },
    { data: { source: '9B', target: '9D' } },
    { data: { source: '6D', target: '10A' } },
    { data: { source: '8D', target: '10A' } },
    { data: { source: '9A', target: '10A' } },
    { data: { source: '9B', target: '10A' } },
    { data: { source: '9B', target: '10B' } },
    { data: { source: '10A', target: '10B' } },
    { data: { source: '3D', target: '10C' } },
    { data: { source: '5D', target: '10C' } },
    { data: { source: '7D', target: '10C' } },
    { data: { source: '8D', target: '10C' } },
    { data: { source: '9A', target: '10C' } },
    { data: { source: '9B', target: '10C' } },
    { data: { source: '10A', target: '10C' } },
    { data: { source: '1D', target: '10D' } },
    { data: { source: '2D', target: '10D' } },
    { data: { source: '3D', target: '10D' } },
    { data: { source: '4D', target: '10D' } },
    { data: { source: '5D', target: '10D' } },
    { data: { source: '6D', target: '10D' } },
    { data: { source: '7D', target: '10D' } },
    { data: { source: '8D', target: '10D' } },
    { data: { source: '9D', target: '10D' } },
    { data: { source: '10C', target: '10D' } },
    { data: { source: 'EventBus', target: '11A' } },
    { data: { source: '10B', target: '11B' } },
    { data: { source: 'AggregatedData', target: '11C' } },
    { data: { source: 'StatusEvents', target: '11D' } },
    { data: { source: 'Logs', target: '12A' } },
    { data: { source: 'Data', target: '12B' } },
    { data: { source: '1D', target: '12C' } },
    { data: { source: '5B', target: '12C' } },
    { data: { source: '5C', target: '12C' } },
    { data: { source: '9A', target: '12C' } },
    { data: { source: '12A', target: '12D' } },
    { data: { source: '12B', target: '12D' } }
  style: [
    {
      selector: 'node',
      style: {
        'background-color': '#007bff',
        'label': 'data(label)',
        'color': '#ffffff',
        'text-outline-width': 2,
        'text-outline-color': '#007bff',
        'font-size': '8px',
        'text-valign': 'center',
        'text-halign': 'center',
        'width': 50,
        'height': 50
      }
    },
    {
      selector: 'edge',
      style: {
        'width': 2,
        'line-color': '#cccccc',
        'target-arrow-color': '#cccccc',
        'target-arrow-shape': 'triangle'
      }
    },
    {
      selector: '.highlighted',
      style: {
        'background-color': '#ff4136',
        'line-color': '#ff4136',
        'target-arrow-color': '#ff4136',
        'transition-property': 'background-color, line-color, target-arrow-color',
        'transition-duration': '0.5s'
      }
    }
  ],

  layout: {
    name: 'dagre',
    rankDir: 'TB',
    nodeSep: 30,
    edgeSep: 10,
    rankSep: 60
  }
});

// Clear previous highlights
function clearHighlights() {
  cy.elements().removeClass('highlighted');
}

// Recursively highlight upstream
function highlightUpstream(node) {
  node.addClass('highlighted');
  node.incomers('edge').addClass('highlighted');
  node.incomers('node').forEach(highlightUpstream);
}

// On node click
cy.on('tap', 'node', function(evt){
  clearHighlights();
  var node = evt.target;
  highlightUpstream(node);
});
</script>

</body>
</html>
